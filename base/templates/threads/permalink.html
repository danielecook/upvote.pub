{% extends "home.html" %}

{% block left %}
{% from "macros.html" import render_pub %}
    {{ render_pub(thread, user, slugify) }}

{% if thread.pub_abstract %}
    <h5>Abstract</h5>
    <div class='well jax'>
        {{ thread.pub_abstract }}
    </div>
{% endif %}

<div class="thread-comment-section">
    {% if user is defined and user != None %}
    <h5>Submit a comment</h5>
    <div class="comment-form-parent">
        <textarea class="form-control thread-comment-box"></textarea>       
        <button class="btn btn-sm btn-primary submit-comment main-submit">
                Submit</button>
    </div>
    {% else %}
    <br>
    <i>
        <a href="{{ url_for('frontends.login') }}">
            Login
        </a> or 
        <a href="{{ url_for('frontends.register') }}">
            register
        </a> to comment!
    </i>
    {% endif %}
</div>


<div class="row"></div>
<br>
<div>
    <h4>Comments</h4>
    <hr>
</div>

<div class="row comments-tree">
    {%- for comment in thread.get_comments() recursive %}
        <div class="comments-element" name="{{ comment.id }}"> 
            <div class="post-listing-meta">
                <a href="{{ url_for('users.user_profile', username=comment.user.username) }}">
                    <strong>{{ comment.user.username }}</strong></a> {{ comment.pretty_date() }} 
            </div>
            <p class="comment-body">{{ comment.text }}</p>
            <div class='comment-meta'><a href="javascript:void(0)">reply</a></div>

            <textarea class="nested-comment-text-box form-control"></textarea>
            <button class="btn btn-sm btn-primary submit-comment nested-submit-comment-button">
                Submit</button>
        {%- if comment.get_comments() -%}
            {{ loop(comment.get_comments()) }}
        {%- endif %}
        </div>
    {%- endfor %}
</div>

<br>
<br>

{% endblock %}

{% block scripts %}
{{ super() }}
<script type="text/javascript">
$(document).ready(function() {
    $(document).on('click', 'button.submit-comment', function() {
        // We will submit user id data via session.
        // Don't need to include parent comment because we are commenting 
        // on a thread, not a comment!
        var parent_id = "";
        var comment_text = "";
        var not_nested =  $(this).hasClass('main-submit').toString();
        var $parent_comment = $(this).parent('div.comments-element');
        // the logic is funky because we are using string booleans...
        if (not_nested == 'false') {
            // it is nested 
            parent_id = $(this).parent('div.comments-element').attr('name');
            $comment_box = $(this).parent('div.comments-element').children(
                'textarea.nested-comment-text-box')
            $button_box = $(this).parent('div.comments-element').children(
                'button.nested-submit-comment-button');
            comment_text = $comment_box.val();
            $comment_box.val('');
            $button_box.toggle();
            $comment_box.toggle();

        } else {
            // it isn't nested
            $comment_box = $(this).parent('div.comment-form-parent').children(
                'textarea.thread-comment-box');
            comment_text = $comment_box.val();
            $comment_box.val('');
        }
        
        if (comment_text == null || comment_text == '') {
            alert("Please enter a valid comment!");
            return;
        }

        var thread_id = "{{ thread.id }}";
        var post_to = '/apis/comments/submit/';
        {% if user and user != None %}
            $.post(post_to, { 
                parent_id: parent_id, // empty if top-level (none)
                thread_id: thread_id,
                comment_text: comment_text },
                function(response) {
                    var write_string = 
                        '<div class="comments-element" name="'+ response.comment_id + '">' +
                        '<div class="post-listing-meta">' + 
                        '<a href="/users/{{ user.username }}/">' +
                        '<strong>{{ user.username }}</strong></a>' + 
                        ' ' + response.date + 
                        '</div>' +
                        '<p class="comment-body">' + response.comment_text + '</p>' + 
                        ' <a href="javascript:void(0)" class="comment-meta">reply</a>' +
                        '<textarea class="nested-comment-text-box form-control"></textarea>' +
                        '<button class="btn btn-sm btn-primary submit-comment ' + 
                        'nested-submit-comment-button">Submit</button>';

                    if (not_nested == 'true') {
                        $('div.comments-tree').prepend(write_string);
                    } else {
                        $parent_comment.append(write_string);
                    }
                }, 'json'
            );              
        {% else %}
            alert("You must be logged in to do that!");
        {% endif %}
    });

    $(document).on('click', '.comment-meta a', function(e) {
        $(this).parent().parent().children('textarea.nested-comment-text-box').toggle();
        $(this).parent().parent().children('button.nested-submit-comment-button').toggle();
    });

});
</script>
{% endblock %}
