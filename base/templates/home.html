{% extends "base.html" %}

{% block content %}
<div class="col-md-9">
    {% if page_title %}

              {% if num_searches is defined %}
                <p class='pull-right'>{{num_searches }} result{{ num_searches|pluralize }}</p>
              {% endif %}

    <h1>{{ page_title }}{% if page_subtitle %} <small>{{ page_subtitle }}</small>{% endif %}</h1>
    <hr />
    {% endif %}

  <div id="messages-wrap">
    <div id="messages">
      {% for category, msg in get_flashed_messages(with_categories=true) %}
      <div class="flash-{{ category }} alert alert-dismissable alert-{{ category }} flash-banner">
          <p>{{ msg }}</p>
      </div>
      {% endfor %}
    </div>
  </div>

  {% block left %}
        {% from "macros.html" import render_pub %}
              <div class="spacer"></div>
              {% for thread in thread_paginator.items %}
                    {{ render_pub(thread, user, slugify) }}
              {% endfor %}

              <ul class="pager text-center">
                    {% if thread_paginator.has_prev %}
                        <li><a href="?page={{ thread_paginator.prev_num }}">prev</a></li>
                    {% else %}
                        <li style="opacity:0.3;"><a>prev</a></li>
                    {% endif %}
                    {% if thread_paginator.has_next %}
                        <li><a href="?page={{ thread_paginator.next_num }}">next</a></li>
                    {% else %}
                        <li style="opacity:0.3;"><a>next</a></li>
                    {% endif %}
              </ul>
  {% endblock %}
</div>

<div class="col-md-3">
  {% block right %}
    {% if user is defined and user != None %}
        <!-- -->
    {% else %}
        <!-- <h4 class="pre-reg-info">Please register or login to post!</h4>-->
    {% endif %}

    {% block create_buttons %}

        <form method="GET" action="/search/" class="" role="search">
            <div class="form-group">
                <input type="text" name="query" class="search form-control" 
                    placeholder="Search">
            </div>
        </form>
        {% if cur_subreddit and cur_subreddit.name %}
            <a href="{{ url_for('threads.submit', subreddit_name=cur_subreddit.name) }}">
                <button class="btn btn-primary btn-block submit-post-button">
                    submit to {{ cur_subreddit.name }}</button>
            </a>
        {% endif %} 

    {% if cur_subreddit %}
        {{ cur_subreddit.desc }}
    {% endif %}

    {% endblock %}

    <h4 class="subreddit-desc">Subs</h4>
    <ul id="sublist">
        {% for subreddit in subreddits[:10] %}
        {% if subreddit.name == cur_subreddit.name %}
            <li><strong><a href="/r/{{ subreddit.name }}">{{ subreddit.name }}</a></strong></li>
        {% else %}
            <li><a href="/r/{{ subreddit.name }}">{{ subreddit.name }}</a></li>
        {% endif %}
        {% endfor %}
    </ul>
  {% endblock %}
</div>

{% endblock %}

{% block scripts %}
<script type="text/javascript">
$(document).ready(function() {
    $(document).on('click', 'a.listing-vote-button', function() {
        var $vote_button = $(this); // cache this! can't access in callback!
        var thread_id = $vote_button.parent().parent().attr('name');
        var post_to = '/apis/threads/vote/'; 
        if ($vote_button.attr("data-voted") === "true") {
            $vote_button.css("color", "#888");
            $vote_button.attr("data-voted", "false");
        } else {
            $vote_button.css("color", "#1484e4");
            $vote_button.attr("data-voted", "true");
        }
        {% if user is defined and user != None %}
            $.post(post_to, { thread_id: thread_id },
                function(response) {
                    var new_vote_count = response.new_votes.toString();
                    var vote_status = response.vote_status;
                    $vote_button.parent().
                        children('div.listing-votes-number').html(new_vote_count);
                }, 'json'
            );
        {% else %}
            alert("You must be logged in to do that!");
        {% endif %}
    });
    //
    //
});
</script>
{% endblock %}
