{% extends "base.html" %}

{% block content %}
<div class="col-md-9">
  {% block left %}
  {% from "macros.html" import render_pub %}
      {% if num_searches is defined %}
        <h4 class="highlight">We have found {{ num_searches }} search results </h4>
        <br>
      {% endif %}
      <div class="spacer"></div>
      {% for thread in thread_paginator.items %}
            {{ render_pub(thread, user) }}
      {% endfor %}

      <ul class="pager text-center">
        {% if thread_paginator.has_prev %}
            <li><a href="?page={{ thread_paginator.prev_num }}">prev</a></li>
        {% else %}
            <li style="opacity:0.3;"><a>prev</a></li>
        {% endif %}
        {% if thread_paginator.has_next %}
            <li><a href="?page={{ thread_paginator.next_num }}">next</a></li>
        {% else %}
            <li style="opacity:0.3;"><a>next</a></li>
        {% endif %}
      </ul>
  {% endblock %}
</div>

<div class="col-md-3 right-bar">
  {% block right %}
    {% if user is defined and user != None %}
        <!-- -->
    {% else %}
        <!-- <h4 class="pre-reg-info">Please register or login to post!</h4>-->
    {% endif %}
    {% block create_buttons %}
    <div class="row">
        {% block user_dashboard %}
        {% endblock %}


        <form method="GET" action="/search/" class="" role="search">
            <div class="form-group">
                <input type="text" name="query" class="search form-control" 
                    placeholder="Search reddit!">
            </div>
        </form>  
        {% if cur_subreddit is defined %}
            <a href="{{ url_for('threads.submit', subreddit_name=cur_subreddit.name) }}">
                <button class="btn btn-primary btn-block submit-post-button">
                    submit to {{ cur_subreddit.name }}</button>
            </a>
        {% else %}
            <a href="{{ url_for('threads.submit', subreddit_name='frontpage') }}">
                <button class="btn btn-primary submit-post-button">submit post</button></a>
        {% endif %} 
        </div>


    {% if cur_subreddit is defined %}
    <p class="subreddit-desc">
        {{ cur_subreddit.desc }}
    </p>
    {% endif %}

    {% endblock %}

    <h4 class="subreddit-desc">Subreddits</h4>
    <ul id="subreddit-list">
        {% for subreddit in subreddits[:10] %}
        <li><a href="/r/{{ subreddit.name }}">{{ subreddit.name }}</a></li>
        {% endfor %}
    </ul>
    <a class="align-right-col" href="{{ url_for('subreddits.view_all') }}">view all</a>
  {% endblock %}
</div>

{% endblock %}

{% block scripts %}
<script type="text/javascript">
$(document).ready(function() {
    $(document).on('click', 'a.listing-vote-button', function() {
        var $vote_button = $(this); // cache this! can't access in callback!
        var thread_id = $vote_button.parent().parent().attr('name');
        var post_to = '/apis/threads/vote/'; 
        if ($vote_button.attr("data-voted") === "true") {
            $vote_button.css("color", "#000");
            $vote_button.attr("data-voted", "false");
        } else {
            $vote_button.css("color", "#1484e4");
            $vote_button.attr("data-voted", "true");
        }
        {% if user is defined and user != None %}
            $.post(post_to, { thread_id: thread_id },
                function(response) {
                    var new_vote_count = response.new_votes.toString();
                    var vote_status = response.vote_status;
                    $vote_button.parent().
                        children('div.listing-votes-number').html(new_vote_count);
                }, 'json'
            );
        {% else %}
            alert("You must be logged in to do that!");
        {% endif %}
    });
    //
    //
});
</script>
{% endblock %}
